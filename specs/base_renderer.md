# 仕様書（最小構成）: 図生成ベースクラス

## 1. 目的

- 論文用の図を、パワーポイントのように「配置して作る」感覚で作成できるツールの基盤を作る。
- ただし **図の中に画像を埋め込まず**、**画像ファイルはパス参照**で扱う（再生成時も同じ素材を参照して描画する）。
- 将来的にGUI編集へ拡張する前提として、まずは  
  **設定ファイル（要素の集合）→ 出力画像**  
  を実現するベースクラスを定義する。

---

## 2. 今回のスコープ（最小）

- 1枚の出力画像（キャンバス）を生成できること。
- 入力は「要素で構成された設定ファイル」。
- 要素種別は **画像** と **文字** のみ。
- 描画順は要素の並び、または明示的に指定された `z` によって決まる。

---

## 3. 非スコープ（今回やらない）

- GUI編集（ドラッグ、整列、ハンドル操作など）
- 複数ページ／複数図の一括出力
- 高度なテキスト処理（縦書き、禁則処理、数式レンダリングなど）
- PDF / SVG 等のベクタ出力（まずはPNGなどのラスター出力のみ）
- 画像フィルタ、マスク、クリッピング、ブレンド等の高度な描画処理

---

## 4. 入出力仕様

### 4.1 入力（設定ファイル）

- 形式候補: **JSON** または **YAML**
  - 最小実装を優先し、当面は **JSON推奨**
- 設定ファイルは以下の情報を含む：
  1. キャンバス定義
  2. 画像素材のパス参照および配置情報
  3. 文字列および文字配置情報
- 「画像ファイルの座標を設定するファイル」
  「文字を設定するファイル」
  「文字の座標やサイズを設定するファイル」
  は、最小段階では **1ファイルに統合してよい**
  - 将来的には `include` による分割を想定する

### 4.2 出力

- 出力ファイル形式: **PNG**（最低限）
- 出力パスは設定ファイル側で指定可能とする

---

## 5. 座標系・寸法の定義

### 5.1 キャンバス

- サイズ指定: `width`, `height`
- 単位: **px**
- 原点: 左上 `(0, 0)`
- x軸: 右方向が正
- y軸: 下方向が正

### 5.2 要素座標

- 画像・文字ともに **左上基準（top-left）**
- 画像サイズ指定は以下のどちらかに統一する
  - `scale`
  - `width / height`
  - 最小仕様では `scale` を採用
- 回転は最小仕様では未対応
  - 将来拡張のため `rotation_deg` フィールドを用意してもよい

---

## 6. 設定ファイルのデータモデル（最小）

### 6.1 全体構造

- `version`: 設定スキーマのバージョン（例 `"0.1"`）
- `canvas`: キャンバス情報
- `assets`: 画像素材のパス解決用情報（任意）
- `elements`: 描画要素の配列（画像または文字）

### 6.2 設定例（JSON）

```json
{
  "version": "0.1",
  "output": { "path": "build/figure.png" },
  "canvas": {
    "width": 1600,
    "height": 1200,
    "background": "#FFFFFF"
  },
  "assets": {
    "base_dir": "./assets"
  },
  "elements": [
    {
      "type": "image",
      "id": "img1",
      "path": "microscope/sample.png",
      "x": 100,
      "y": 120,
      "scale": 0.8
    },
    {
      "type": "text",
      "id": "label_a",
      "text": "(a)",
      "x": 80,
      "y": 80,
      "font": {
        "family": "Arial",
        "size": 48,
        "color": "#000000"
      }
    }
  ]
}
```

### 6.3 要素定義（共通）

- `type`: `"image"` または `"text"`
- `id`: 一意な識別子（将来GUIで利用）
- `x`, `y`: 描画位置（px）
- `z`: 描画順（任意。未指定の場合は配列順）

### 6.4 画像要素（image）

- `path`: 画像ファイルの相対パス（`assets.base_dir` 基準）
- `scale`: 拡大率（1.0 が等倍）
- 将来拡張用（任意）
  - `opacity`（0〜1）
  - `rotation_deg`
  - `anchor`

### 6.5 文字要素（text）

- `text`: 描画する文字列
- `font.family`, `font.size`, `font.color`
- 最小仕様では以下は非対応
  - 太字・斜体
  - 行間調整
  - 文字揃え（将来 `align` を追加可能）

---

## 7. ベースクラス仕様

### 7.1 クラス名

- `FigureRenderer`
- 代替案: `FigureBuilder`, `DrawingEngine`

### 7.2 責務

- 設定ファイルを読み込み、内部モデルに変換する
- 画像パスを解決し、素材をロードする
- キャンバスを生成し、要素を順に描画する
- 出力画像として保存する

### 7.3 非責務

- GUI操作
- 設定ファイル編集機能
- 自動レイアウト・整列
- 数式やLaTeXなどの特殊レンダリング

---

## 8. 公開API（最小）

### 8.1 初期化

- `__init__(config_path: str | Path)`
  - 設定ファイルパスを受け取る

### 8.2 主機能

- `render(output_path: str | Path | None = None) -> Path`
  - 設定に従って描画し、画像を保存する
  - `output_path` が指定された場合は設定より優先する

### 8.3 内部メソッド（参考）

- `_load_config()`
- `_validate_config(cfg)`
- `_resolve_path(rel)`
- `_render_canvas(cfg)`
- `_draw_element(canvas, element_cfg)`

---

## 9. バリデーション・エラーハンドリング

### 9.1 バリデーション対象

- 必須キーの存在確認
- `type` の妥当性
- 画像ファイルの存在確認
- 数値パラメータの妥当性（正の値など）

### 9.2 エラー方針

- 原則として **例外を投げて停止**
- 例外メッセージには以下を含める
  - 要素ID（存在する場合）
  - 問題のある設定項目

---

## 10. 拡張のための設計メモ

- `id` は必須とする
- `version` によるスキーマ管理を行う
- 要素は `type` による分岐で拡張可能にする
- 相対パスの基準は `assets.base_dir` に統一する

---

## 11. 受け入れ条件（最小要件）

1. 設定ファイル1つからPNG画像を1枚生成できる
2. 画像は埋め込まず、パス参照で扱われる
3. 画像要素と文字要素を同時に配置できる
4. 設定ミス時に原因が分かる形で失敗する
